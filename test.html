---
layout: default
title: home
---
</head><body><div id='preview-contents' class='note-content'>

<h1 id="ena-upload-protocol">ENA Upload Protocol</h1>

<p></p>

<p>| <strong>Author</strong>  Firas Said Midani <br>
| <strong>E-mail</strong>  firas.midani@duke.edu <br>
| <strong>Date Created</strong> 2017.01.13 <br>
| <strong>Date Modified</strong> 2017.01.13</p>

<p>id: 20160524-215821</p>

<div><div class="toc"><div class="toc">
<ul>
<li><a href="#ena-upload-protocol">ENA Upload Protocol</a><ul>
<li><a href="#required-files">Required files</a></li>
<li><a href="#desired-output">Desired output</a></li>
<li><a href="#general-outline-of-the-process">General outline of the process:</a><ul>
<li><a href="#step-1-create-mapping-file-for-your-samples">STEP 1 Create mapping file for your samples</a></li>
<li><a href="#step-2-de-multiplex-reads-into-one-large-fastq-file">STEP 2 De-multiplex reads into one large FASTQ file</a><ul>
<li><a href="#so-how-do-you-de-multiplex-with-qiime">So, how do you de-multiplex with QIIME?</a></li>
</ul>
</li>
<li><a href="#step-3-distribute-reads-into-sample-specific-files">STEP 3 Distribute reads into sample-specific files</a><ul>
<li><a href="#so-how-do-you-distribute-samples-with-qiime">So, how do you distribute samples with QIIME?</a></li>
</ul>
</li>
<li><a href="#step-4-formatting-headers-to-proper-ena-format">STEP 4 Formatting headers to proper ENA format</a><ul>
<li><a href="#so-how-do-you-actually-format-the-headers-efficiently">So, how do you actually format the headers efficiently?</a></li>
</ul>
</li>
<li><a href="#step-5-compressing-file-with-gzip-and-computing-their-md5-hashes">STEP 5 Compressing file with Gzip and computing their MD5 hashes</a><ul>
<li><a href="#computing-md5-hashes-of-gzippped-fastq-files-into-a-single-file">Computing MD5 hashes of gzippped FASTQ files into a single file</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>



<h2 id="required-files">Required files</h2>

<p>You need four files:</p>

<ol><li rel="1"><p>Index read file</p></li>
<li rel="2"><p>Forward read file</p></li>
<li rel="3"><p>Reverse read file</p></li>
<li rel="4"><p>Mapping file</p></li>
</ol>

<p>The sequencing core should provide you with the original index, forward, and reverse read files. You should have created a mapping file with proper format. The mapping file, at but at the bare minimum, it needs <strong>#SampleID</strong>, <strong>BarcodeSequence</strong>, <strong>LinkerPrimerSequence</strong>, and <strong>Description</strong> columns.  It can also include additional columns and should look like the following</p>

<table><tbody><tr style="font-weight:bold">  <td align="left">#SampleID</td>  <td align="left">BarcodeSequence</td>  <td align="left">LinkerPrimerSequence</td>  <td align="left">Row</td>  <td align="left">Column</td>  <td align="left">Plate</td>  <td align="left">Description</td></tr><tr>  <td align="left">SMIC.030.05.Day.02</td>  <td align="left">TCCCTTGTCTCC</td>  <td align="left">CAAGCAGAAGACGGCATACGAGAT</td>  <td align="left">A</td>  <td align="left">1</td>  <td align="left">1</td>  <td align="left">806rcbc0</td></tr><tr>  <td align="left">SMIC.040.01.Day.02</td>  <td align="left">TGCATACACTGG</td>  <td align="left">CAAGCAGAAGACGGCATACGAGAT</td>  <td align="left">B</td>  <td align="left">1</td>  <td align="left">1</td>  <td align="left">806rcbc12</td></tr><tr>  <td align="left">SMIC.014.01.Day.02</td>  <td align="left">GCGATATATCGC</td>  <td align="left">CAAGCAGAAGACGGCATACGAGAT</td>  <td align="left">C</td>  <td align="left">1</td>  <td align="left">1</td>  <td align="left">806rcbc24</td></tr></tbody></table>



<h2 id="desired-output">Desired output</h2>

<p>For more details, see ENA <a href="https://www.ebi.ac.uk/ena/submit/read-file-formats" target="_blank"> Supported read file formats</a> page.</p>

<p>Briefly, the European Nucleotide Archives need sample-specific FASTQ files. Each FASTQ file must only include reads corresponding to a single sample. If paired end sequencing was performed, the forward and reverse reads must be in separate files.  Here is the ENA excerpt about the expected FASTQ format.</p>

<blockquote>
  <p><strong>Fastq format</strong></p>
  
  <p>We recommend that read data is either submitted in BAM or CRAM format. However, single and paired reads are accepted as Fastq files that meet the following the requirements:</p>
  
  <ul><li><p>Quality scores must be in Phred scale. Both ASCII and space delimitered decimal encoding of quality scores are supported. We will automatically detect the Phred quality offset of either 33 or 64.</p></li>
  <li><p>No technical reads (adapters, linkers, barcodes) are allowed.</p></li>
  <li><p>Single reads must be submitted using a single Fastq file and can be submitted with or without read names. <br>
  <em>Paired reads must split and submitted using either one or two Fastq files. The read names must have a suffix identifying the first and second read from the pair, for example ‘/1’ and ‘/2’ (regular expression for the reads: “^@([a-zA-Z0-9_-]+:[0-9]+:[a-zA-Z0-9]+:[0-9]+:[0-9]+:[0-9-]+:[0-9-]+) ([12]):[YN]:[0-9]</em>[02468]:[ACGTN]+$”).</p></li>
  <li><p>The first line for each read must start with ‘@’.</p></li>
  <li><p>The base calls and quality scores must be separated by a line starting with ‘+’.</p></li>
  <li><p>The Fastq files must be compressed using gzip or bzip2.</p></li>
  </ul>
</blockquote>

<p>By default (checked) for MiSeq Runs, the sequencing core provides us with FASTQ files with</p>

<div class="checklist"><div class="checklist-item"><input type="checkbox" checked="checked"> Quality scores in Phred scale.</div><div class="checklist-item"><input type="checkbox" checked="checked"> No technical reads (adapters, linkers, barcodes) included. Adapters and linkers were trimmed and barcode included seperately in the index read file.</div><div class="checklist-item"><input type="checkbox"> The reads names <strong>DO NOT</strong> have a suffix identifying the first and second read from the pair, for example ‘/1’ and ‘/2’.</div><div class="checklist-item"><input type="checkbox" checked="checked"> The first line for each starts with ‘@’.</div><div class="checklist-item"><input type="checkbox" checked="checked"> The base calls and quality scores are sperated by a line starting with ‘+’.</div><div class="checklist-item"><input type="checkbox"> The fastq files compressed using gzip, <strong>BUT</strong> as you will see below,  we will have to decompress the files for proper formatting.</div></div>

<p>Accordingly, we will have to manipulate our raw FASTQ files to get them to the proper format.</p>



<h2 id="general-outline-of-the-process">General outline of the process:</h2>

<div class="checklist"><div class="checklist-item"><input type="checkbox"> For each run (in case, your project samples were processed over multiple runs):

<div class="checklist"><div class="checklist-item"><input type="checkbox"> Create a mapping file for the samples (in case, your sequencing run contains samples for other projects) to be used by qiime</div><div class="checklist-item"><input type="checkbox"> For each forward and reverse reads separately

<div class="checklist"><div class="checklist-item"><input type="checkbox"> De-multiplex reads into one large FASTQ file</div><div class="checklist-item"><input type="checkbox"> Distribute reads into sample-specific FASTQ files.</div><div class="checklist-item"><input type="checkbox"> Format headers of sequences in FASTQ files to desired ENA format.</div><div class="checklist-item"><input type="checkbox"> Compress files with Gzip.</div><div class="checklist-item"><input type="checkbox"> Compute MD5 128-bit hashes for the compressed files with <code>md5sum</code></div></div></div></div></div><div class="checklist-item"><input type="checkbox"> Move all sample-specific compressed forward and reverse into a storage area that allows FTP transfer (e.g. isilon storage)</div><div class="checklist-item"><input type="checkbox"> Move MD5 hashes to local machine in order to incoroporate into ENA mapping files (needed for submission).</div></div>

<hr>



<h3 id="step-1-create-mapping-file-for-your-samples">STEP 1 Create mapping file for your samples</h3>

<p>Often, sequencing runs contain samples from a hodge-podge of experiments. To process the sequencing file in QIIME (for microbial community profiling), you should have already constructed mapping file. Here, you will simply need to remove rows for samples that you do not need. Only keep rows for samples that will be included in the ENA repository.  There are several ways to do it. You can use Excel or you can your favorite scripting language (<code>python</code>, <code>R</code>,  or even <code>bash</code>/<code>awk</code>  if you’re adventurous).</p>

<hr>



<h3 id="step-2-de-multiplex-reads-into-one-large-fastq-file">STEP 2 De-multiplex reads into one large FASTQ file</h3>

<p>The sequencing core provides you with three FASTQ files for the forward reads, reverse reads, and the index reads. The reads are organized in the same order across all three files. In other words, the 100th read in the forward file is paired with the 100th read in the reverse and index files. De-multiplexing takes the forward and reverse reads and modify their headers to include information about the barcode (and thus sample) corresponding to the reads.  </p>

<p>Here is what an index read looks like.</p>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">@M00830:212:000000000-A9BBF:1:1101:15315:1443 1:N:0:0
</div><div class="hljs-line">AACGAGAACTGA
</div><div class="hljs-line">+
</div><div class="hljs-line">A&gt;A&gt;&gt;11AC1F@
</div></code></pre>

<p> <br>
Here is what the corresponding forward read looks.</p>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">@M00830:212:000000000-A9BBF:1:1101:15315:1443 1:N:0:0
</div><div class="hljs-line">TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATTGGTCAGTCTGTCTTAAAAGTTCGGGGCTTAACCCCGTGATGGGATGGAAACTGCCAATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTG
</div><div class="hljs-line">+
</div><div class="hljs-line">&gt;1&gt;1&gt;@B&gt;B1&gt;CA11FEFFEGGHF?00BGFHHHBEGEGGGHFDEGGAE/E?ECGC/&gt;?G0112BGHHHHHHH&gt;GFHH1&gt;2?//&gt;BCHFGG1/?/&lt;B/0?F/?FFGGGFFFHG01?1&lt;&lt;1&lt;1FFHFGGCA?-ACGGBC0=DBGDGCH00C;;
</div></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">@M00830:212:000000000-A9BBF:1:1101:15315:1443 1:N:0:0
</div><div class="hljs-line">AACGAGAACTGA
</div><div class="hljs-line">+
</div><div class="hljs-line">A&gt;A&gt;&gt;11AC1F@
</div></code></pre>

<p> <br>
De-multiplexing takes these two files and combines them into one with more informative header. For example, once the above read is de-multiplexed, this is what you get:</p>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">&gt;SMIC.017.03.Day.07_0 M00830:212:000000000-A9BBF:1:1101:15315:1443 1:N:0:0 orig_bc=AACGA GAACTGA new_bc=AACGAGAACTGA bc_diffs=0
</div><div class="hljs-line">2. TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATTGGTCAGTCTGTCTTAAAAGTTCGGGGCTTA ACCCCGTGATGGGATGGAAACTGCCGATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTG
</div><div class="hljs-line">3. +
</div><div class="hljs-line">4. &gt;1&gt;1&gt;@B&gt;B1&gt;CA11FEFFEGGHF?00BGFHHHBEGEGGGHFDEGGAE/E?ECGC/&gt;?G0112BGHHHHHHH&gt;GFHH1&gt;2?//&gt;BCHF
</div><div class="hljs-line">   GG1/?/&lt;B/0?F/?FFGGGFFFHG01?1&lt;&lt;1&lt;1FFHFGGCA?-ACGGBC0=DBGDGCH00C;;
</div></code></pre>

<p>where</p>

<ul><li><p><strong>SMIC.07.03.Day.07_0</strong> is the sample name as indicated from the mapping file and <strong>_0</strong> indicates that this is the first read in the FASTQ files (de-multiplexing with QIIME uses <a href="https://skillcrush.com/2013/01/17/why-programmers-start-counting-at-zero/" target="_blank">0-based indexing</a>).</p></li>
<li><p><strong>orig_bc</strong>  indicate the corresponding index sequenced in the run.</p></li>
<li><p><strong>new_bc</strong> indicates the corresponding barcode in the mapping file that matches the index sequenced. By default, QIIME pipeline allows for a single base error in the index/barcode. So, this new_bc might be different than orig_bc.</p></li>
<li><p><strong>bc_diff</strong> indicates the number of base differences between orig_bc and new_bc.</p></li>
<li><p>the rest of the in-between are the default output by the Illumina MiSeq machine. Some of it is informative but you do not necessarily need it. If you are curious about what these numbers mean, see <a href="http://support.illumina.com/help/SequencingAnalysisWorkflow/Content/Vault/Informatics/Sequencing_Analysis/CASAVA/swSEQ_mCA_FASTQFiles.htm" target="_blank">this document</a> by Illumina. Anyways, we will come back to this in a bit.</p></li>
</ul>



<h4 id="so-how-do-you-de-multiplex-with-qiime">So, how do you de-multiplex with QIIME?</h4>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=600</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">module load qiime
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">seq_path=/home/lad44/davidlab/users/fsm/seq_data/2014.07.07.seq
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">srun -o <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/slurm.log/split.library.forward.out \
</div><div class="hljs-line">     <span class="hljs-_">-e</span> <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/slurm.log/split.library.forward.err \
</div><div class="hljs-line">     split_libraries_fastq.py \
</div><div class="hljs-line">     -m <span class="hljs-variable">$seq_path</span>/mapping/2014.07.07.mapping_corrected_cholera.only.txt \
</div><div class="hljs-line">     -b <span class="hljs-variable">$seq_path</span>/rawdata/decompressed/Undetermined_S0_L001_I1_001.fastq \
</div><div class="hljs-line">     -i <span class="hljs-variable">$seq_path</span>/rawdata/decompressed/Undetermined_S0_L001_R1_001.fastq \
</div><div class="hljs-line">     -o <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/seqs.forward.fna \
</div><div class="hljs-line">     --rev_comp_mapping_barcodes \
</div><div class="hljs-line">     --store_demultiplexed_fastq \
</div><div class="hljs-line">     --retain_unassigned_reads \
</div><div class="hljs-line">     -r 999 -p 0.0001 -n 999 -q 0 \
</div><div class="hljs-line">     --max_barcode_errors 1.5
</div></code></pre>

<p>As you have noticed, I am running my commands as jobs on a high-throughput computing (HPC) cluster. In our case, the cluster is HARDAC. I am basically*</p>

<ul><li><p>requesting 8GB resources for 10 hours (I always ask for ten times the time I think I’ll need)</p></li>
<li><p>loading the QIIME module (into the environment so that my code can use QIIME functions),</p></li>
<li><p><code>srun</code> to request a job where</p>

<ul>
<li><p>we specify the path of the output and error log files with <code>-o</code> and <code>-e</code> arguments.</p></li>
<li><p>we use the command <code>split_libraries_fastq.py</code> from QIIIME.</p></li>
<li><p><code>-m</code> corresponds to path of mapping file</p></li>
<li><p><code>-b</code> corresponds to path of index read file</p></li>
<li><p><code>-i</code> corresponds to path of forward (or reverse) read file</p></li>
<li><p><code>-o</code> specifies path of the output of de-multiplex FASTQ file and its name</p></li>
<li><p><code>--rev_comp_mapping_barcodes</code> forces lookup of the reverse complement barcode reads</p></li>
<li><p><code>--store_demultiplexed_fastq</code> forces output into FASTQ format otherwise it would be a FASTA file without quality scores. <br>
* Don’t forget to to do this for reverse reads as well.</p></li></ul></li>
</ul>

<p>Time estimate: de-multiplexing takes about 20 minutes for each GB of data. If you process forward and reverse reads in series, obviously, the process would take the double time.</p>

<hr>



<h3 id="step-3-distribute-reads-into-sample-specific-files">STEP 3 Distribute reads into sample-specific files</h3>

<p>De-multiplexing should produce a single large FASTQ file for the forward reads and another large FASTQ files for the reverse. In these files, the header of each read indicates the sample name. The example above identified the read to correspond to <em>SMIC.017.03.Day.07</em>.  The distribution process basically reads each header and copies the read to a new file specific to its original sample. For example, the read in the example would be appended to the file specific to <em>SMIC.017.03.Day.07</em>.</p>



<h4 id="so-how-do-you-distribute-samples-with-qiime">So, how do you distribute samples with QIIME?</h4>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=600</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">module load qiime
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">seq_path=/home/lad44/davidlab/users/fsm/seq_data/2014.07.07.seq
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">srun -o <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/slurm.log/distribute.library.forward.out \
</div><div class="hljs-line">     <span class="hljs-_">-e</span> <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/slurm.log/distribute.library.forward.err \
</div><div class="hljs-line">     split_sequence_file_on_sample_ids.py \
</div><div class="hljs-line">     -i <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/seqs.forward.fna/seqs.fastq \
</div><div class="hljs-line">     -o <span class="hljs-variable">$seq_path</span>/split.library.output.no.joining/split_by_sample/forward/original --file_type fastq
</div></code></pre>

<p>Here, I am*</p>

<ul><li><p>requesting 8GB resources for 10 hours (I always ask for ten times the time I think I’ll need)</p></li>
<li><p>loading the QIIME module (into the environment so that my code can use QIIME functions),</p></li>
<li><p><code>srun</code> to requet a job where</p>

<ul>
<li><p>we specify the path of the output and error log files with <code>-o</code> and <code>-e</code> arguments.</p></li>
<li><p>we use the command <code>split_sequence_file_on_sample_ids.py</code> from QIIIME.</p></li>
<li><p><code>-i</code> corresponds to path of forward (or reverse) read file</p></li>
<li><p><code>-o</code> specifies path of the output of de-multiplex FASTQ file and its name</p></li>
<li><p><code>--file_type fastq</code> specifies the output to remain in FASTQ format</p></li></ul></li>
</ul>

<p>* Don’t forget to to do this for reverse reads as well.</p>

<p>Time estimate: de-multiplexing takes about 2.5 minutes for each GB of data. If you process forward and reverse reads in series, obviously, the process would take the double time.</p>

<hr>



<h3 id="step-4-formatting-headers-to-proper-ena-format">STEP 4 Formatting headers to proper ENA format</h3>

<p>As I discussed in the <a href="#Desired output">Desired output</a> section, we need to modify the headers of all of the reads in the FASTQ files. In particular, we need to do the following:</p>

<ul><li><p>For each read, add suffix identifying whether it is the forward or reverse from a pair, for example ‘/1’ or ‘/2’</p></li>
<li><p>Remove any unnecessary detail in the header that is included by the defaults of the MiSeq (optional)</p></li>
</ul>

<p>In regards to the latter, let me explain briefly the different information included in the header. I am basing the following on <a href="http://support.illumina.com/help/SequencingAnalysisWorkflow/Content/Vault/Informatics/Sequencing_Analysis/CASAVA/swSEQ_mCA_FASTQFiles.htm" target="_blank">this document</a> by Illumina.  For reference, let’s revisit the example of the forward read I showed earlier.</p>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">@M00830:212:000000000-A9BBF:1:1101:15315:1443 1:N:0:0
</div><div class="hljs-line">TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATTGGTCAGTCTGTCTTAAAAGTTCGGGGCTTAACCCCGTGATGGGATGGAAACTGCCAATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTG
</div><div class="hljs-line">+
</div><div class="hljs-line">&gt;1&gt;1&gt;@B&gt;B1&gt;CA11FEFFEGGHF?00BGFHHHBEGEGGGHFDEGGAE/E?ECGC/&gt;?G0112BGHHHHHHH&gt;GFHH1&gt;2?//&gt;BCHFGG1/?/&lt;B/0?F/?FFGGGFFFHG01?1&lt;&lt;1&lt;1FFHFGGCA?-ACGGBC0=DBGDGCH00C;;
</div></code></pre>

<p>The elements in the header are the following.</p>

<table><tbody><tr style="font-weight:bold">  <td align="left">Element</td>  <td align="left">Description</td>  <td>Example from case above</td></tr><tr>  <td align="left"><code>@</code></td>  <td align="left">Each sequence identifier line starts with @</td>  <td></td></tr><tr>  <td align="left"><code>&lt;instrument&gt;</code></td>  <td align="left">Instrument ID</td>  <td>M00830</td></tr><tr>  <td align="left"><code>&lt;run number&gt;</code></td>  <td align="left">Run number on instrument</td>  <td>212</td></tr><tr>  <td align="left"><code>flowcell ID&gt;</code></td>  <td align="left">ID of flow cell</td>  <td>000000000-A9BBF</td></tr><tr>  <td align="left"><code>&lt;lane&gt;</code></td>  <td align="left">Flow cell lane number</td>  <td>1</td></tr><tr>  <td align="left"><code>&lt;tile&gt;</code></td>  <td align="left">Lame tile number</td>  <td>1101</td></tr><tr>  <td align="left"><code>&lt;x_pos&gt;</code></td>  <td align="left">X coordinate of cluster</td>  <td>15315</td></tr><tr>  <td align="left"><code>&lt;y_pos&gt;</code></td>  <td align="left">Y coordinate of cluster</td>  <td>1443</td></tr><tr>  <td align="left"><code>&lt;read&gt;</code></td>  <td align="left">Read number, 1 can be single read or read 2 of paired end</td>  <td>1</td></tr><tr>  <td align="left"><code>&lt;is filtered&gt;</code></td>  <td align="left">Y if the read is filtered, N otherwise</td>  <td>N</td></tr><tr>  <td align="left"><code>&lt;control number&gt;</code></td>  <td align="left">0 when none of the control bits are on, otherwise it is an even number</td>  <td>0</td></tr><tr>  <td align="left"><code>&lt;index sequence&gt;</code></td>  <td align="left">Index sequence</td>  <td>0 (because index reads are sparate in our case)</td></tr></tbody></table>

<p>Most of this information is likely never to be used by you or anyone else. However, it is important to maintain some of it for provenance. For the example below, I only dismiss the run number and the read number, read filter status, and control number. I also appended to the end of the header a hashtag <code>#</code> followed by the index read, then a slash <code>\</code> followed by the read number (<code>#AACGAGAACTGA/1</code>). See the below example</p>

<p>Before formatting header</p>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">@SMIC.017.03.Day.07_0 M00830:212:000000000-A9BBF:1:1101:15315:1443 1:N:0:0 orig_bc=AACGAGAACTGA new_bc=AACGAGAACTGA bc_diffs=0
</div><div class="hljs-line">TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATTGGTCAGTCTGTCTTAAAAGTTCGGGGCTTAACCCCGTGATGGGATGGAAACTGCCAATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTG
</div><div class="hljs-line">+
</div><div class="hljs-line">&gt;1&gt;1&gt;@B&gt;B1&gt;CA11FEFFEGGHF?00BGFHHHBEGEGGGHFDEGGAE/E?ECGC/&gt;?G0112BGHHHHHHH&gt;GFHH1&gt;2?//&gt;BCHFGG1/?/&lt;B/0?F/?FFGGGFFFHG01?1&lt;&lt;1&lt;1FFHFGGCA?-ACGGBC0=DBGDGCH00C;;
</div></code></pre>

<p>After formatting headers</p>



<pre class="prettyprint hljs-dark"><code class="language-tex hljs"><div class="hljs-line">@M00830:000000000-A9BBF:1:1101:15315:1443#AACGAGAACTGA/1
</div><div class="hljs-line">TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATTGGTCAGTCTGTCTTAAAAGTTCGGGGCTTAACCCCGTGATGGGATGGAAACTGCCAATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTG
</div><div class="hljs-line">+
</div><div class="hljs-line">&gt;1&gt;1&gt;@B&gt;B1&gt;CA11FEFFEGGHF?00BGFHHHBEGEGGGHFDEGGAE/E?ECGC/&gt;?G0112BGHHHHHHH&gt;GFHH1&gt;2?//&gt;BCHFGG1/?/&lt;B/0?F/?FFGGGFFFHG01?1&lt;&lt;1&lt;1FFHFGGCA?-ACGGBC0=DBGDGCH00C;;
</div></code></pre>



<h4 id="so-how-do-you-actually-format-the-headers-efficiently">So, how do you actually format the headers efficiently?</h4>

<p>We won’t be using QIIME here. I wrote my own script in <code>python</code> (see below). It acts two arguments:</p>

<ul><li><p>absolute path to FASTQ file*</p></li>
<li><p>read number (1 or 2) indicating whether file contains forward or reverse reads</p></li>
</ul>

<p>* If you give the script a FASTA file, it will give you back a FASTQ file which would not make sense. FASTA files do not have any quality scores for the bases. So, to properly return a FASTQ file, the script by default uses the base calls as the quality scores which is wrong. Ideally, this script would include error checking to either not accept FASTA files or return FASTA files in the same format. If I have time, I will do this <sup>yea … right</sup> <br>
<br></p>

<p><strong>ENA_format_fastq.py</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-python hljs"><div class="hljs-line"><span class="hljs-comment">#!/usr/bin/env python</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-comment">#Author #Firas Said Midani</span>
</div><div class="hljs-line"><span class="hljs-comment">#E_mail #firas.midani@duke.edu</span>
</div><div class="hljs-line"><span class="hljs-comment">#Date Created #2016.11.27</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">from</span> Bio <span class="hljs-keyword">import</span> SeqIO
</div><div class="hljs-line"><span class="hljs-keyword">import</span> sys
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">input_seq_file = sys.argv[<span class="hljs-number">1</span>] <span class="hljs-comment">## file name with absolute path</span>
</div><div class="hljs-line">seq_direction = sys.argv[<span class="hljs-number">2</span>] <span class="hljs-comment">## 1 or 2 for forward or reverse respectively</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">print</span> <span class="hljs-string">'input_seq_file\t'</span>,input_seq_file
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">output_seq_file = input_seq_file.split(<span class="hljs-string">'.fastq'</span>)[<span class="hljs-number">0</span>]
</div><div class="hljs-line">output_seq_file = output_seq_file.replace(<span class="hljs-string">'original'</span>,<span class="hljs-string">'ENA_formatted'</span>) <span class="hljs-comment"># make sure ENA_Formatted directory exists</span>
</div><div class="hljs-line">output_seq_file = <span class="hljs-string">'%s.fastq'</span> % output_seq_file
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">print</span> <span class="hljs-string">'~~~ Formatting ~~~'</span>
</div><div class="hljs-line"><span class="hljs-keyword">print</span> <span class="hljs-string">'   input %s'</span> % input_seq_file
</div><div class="hljs-line"><span class="hljs-keyword">print</span> <span class="hljs-string">'   output %s'</span> % output_seq_file
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">input_seq_handle = open(input_seq_file,<span class="hljs-string">"rU"</span>)
</div><div class="hljs-line">output_seq_handle = open(output_seq_file,<span class="hljs-string">"w+"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> seq_record <span class="hljs-keyword">in</span> SeqIO.parse(input_seq_handle,<span class="hljs-string">"fastq"</span>):
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    old_description = seq_record.description;
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    id_h, info_r, info_f, bc_orig, bc_new, bc_diff = seq_record.description.split(<span class="hljs-string">' '</span>);
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    new_description = <span class="hljs-string">'%s:%s#%s/%s'</span> % (info_r.split(<span class="hljs-string">':'</span>)[<span class="hljs-number">0</span>],
</div><div class="hljs-line">                                       <span class="hljs-string">":"</span>.join(info_r.split(<span class="hljs-string">':'</span>)[<span class="hljs-number">2</span>:]),
</div><div class="hljs-line">                                       bc_orig.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">-1</span>],
</div><div class="hljs-line">                                       seq_direction)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    seq_record.description = <span class="hljs-string">""</span>;
</div><div class="hljs-line">    seq_record.id = new_description;
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    SeqIO.write(seq_record,output_seq_handle,<span class="hljs-string">"fastq"</span>)
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">print</span> <span class="hljs-string">'~~~~~~~~~~~~~~~~~~'</span>
</div><div class="hljs-line"><span class="hljs-keyword">print</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">input_seq_handle.close();
</div><div class="hljs-line">output_seq_handle.close();
</div></code></pre>

<p>The above script only formats one FASTQ file at a time. So, I wrote up a shell script to loop through all of the files of interest. I also submits this script as the job on the cluster. <br>
<br></p>

<p><strong>ENA_format_fastq_library.sh</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=120</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-built_in">source</span> /home/lad44/davidlab/users/fsm/smic_study/vpython/bin/activate
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">seq_path=/home/lad44/davidlab/users/fsm/seq_data/2014.07.07.seq
</div><div class="hljs-line">seq_library=<span class="hljs-variable">$seq_path</span>/split.library.output.no.joining
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$seq_library</span>/split_by_sample/forward/original/*;
</div><div class="hljs-line">    <span class="hljs-keyword">do</span> python <span class="hljs-variable">$seq_library</span>/ENA_format_fastq.py <span class="hljs-variable">$i</span> 1;
</div><div class="hljs-line"><span class="hljs-keyword">done</span>;
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$seq_library</span>/split_by_sample/reverse/original/*;
</div><div class="hljs-line">    <span class="hljs-keyword">do</span> python <span class="hljs-variable">$seq_library</span>/ENA_format_fastq.py <span class="hljs-variable">$i</span> 2;
</div><div class="hljs-line"><span class="hljs-keyword">done</span>;
</div></code></pre>

<p><br> <br>
<strong>ENA_format_fastq_library.slurm</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=120</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">seq_path=/home/lad44/davidlab/users/fsm/seq_data/2014.07.07.seq
</div><div class="hljs-line">seq_library=<span class="hljs-variable">$seq_path</span>/split.library.output.no.joining
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">srun -o <span class="hljs-variable">$seq_library</span>/slurm.log/ENA_format_fastq_library.out\
</div><div class="hljs-line">     <span class="hljs-_">-e</span> <span class="hljs-variable">$seq_library</span>/slurm.log/ENA_format_fastq_library.err \
</div><div class="hljs-line">     sh <span class="hljs-variable">$seq_library</span>/ENA_format_fastq_library.sh
</div></code></pre>

<p><br> <br>
Time estimate: de-multiplexing takes abou 2 minutes for each GB of data. If you process forward and reverse reads in series, as shown in the example above, the process would take the double time.</p>

<hr>



<h3 id="step-5-compressing-file-with-gzip-and-computing-their-md5-hashes">STEP 5 Compressing file with Gzip and computing their MD5 hashes</h3>

<p>This is pretty straightforward except that <code>gzip</code> by default over-writes the input file.  To keep both the raw and compressed version of the FASTQ files, we need to be extra verbose. Basically, we loop through the FASTQ files of interest in our directory. Define the new file name and its file path. Then, compress each file and pipe its compressed to the new filename. FInally, compute the MD5 hash for each file and save it in the same directory.</p>

<p><strong>gzip_fastq_library.sh</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=120</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">seq_path=/home/lad44/davidlab/users/fsm/seq_data/2014.07.07.seq
</div><div class="hljs-line">seq_library=<span class="hljs-variable">$seq_path</span>/split.library.output.no.joining
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$seq_library</span>/split_by_sample/forward/ENA_formatted/*;
</div><div class="hljs-line">    <span class="hljs-keyword">do</span>
</div><div class="hljs-line">        out_file=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$i</span> | sed <span class="hljs-string">'s/ENA_formatted/ENA_formatted_gz/'</span>);
</div><div class="hljs-line">        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$out_file</span>;
</div><div class="hljs-line">        gzip -c <span class="hljs-variable">$i</span> &gt; <span class="hljs-variable">$out_file</span>.gz;
</div><div class="hljs-line">        md5sum <span class="hljs-variable">$out_file</span>.gz &gt; <span class="hljs-variable">$out_file</span>.gz.md5sum
</div><div class="hljs-line"><span class="hljs-keyword">done</span>;
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$seq_library</span>/split_by_sample/reverse/ENA_formatted/*;
</div><div class="hljs-line">    <span class="hljs-keyword">do</span>
</div><div class="hljs-line">        out_file=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$i</span> | sed <span class="hljs-string">'s/ENA_formatted/ENA_formatted_gz/'</span>);
</div><div class="hljs-line">        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$out_file</span>;
</div><div class="hljs-line">        gzip -c <span class="hljs-variable">$i</span> &gt; <span class="hljs-variable">$out_file</span>.gz;
</div><div class="hljs-line">        md5sum <span class="hljs-variable">$out_file</span>.gz &gt; <span class="hljs-variable">$out_file</span>.gz.md5sum
</div><div class="hljs-line">    <span class="hljs-keyword">done</span>
</div></code></pre>

<p><strong>gzip_fastq_library.slurm</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=120</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">seq_path=/home/lad44/davidlab/users/fsm/seq_data/2014.07.07.seq
</div><div class="hljs-line">seq_library=<span class="hljs-variable">$seq_path</span>/split.library.output.no.joining
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">srun -o <span class="hljs-variable">$seq_library</span>/slurm.log/gzip_fastq_library.out\
</div><div class="hljs-line">     <span class="hljs-_">-e</span> <span class="hljs-variable">$seq_library</span>/slurm.log/gzip_fastq_library.err \
</div><div class="hljs-line">     sh <span class="hljs-variable">$seq_library</span>/gzip_fastq_library.sh                                         
</div></code></pre>

<p><br> <br>
Time estimate: de-multiplexing takes about 1 minute for each GB of data. If you process forward and reverse reads in series, as shown in the example above, the process would take the double time.</p>



<h4 id="computing-md5-hashes-of-gzippped-fastq-files-into-a-single-file">Computing MD5 hashes of gzippped FASTQ files into a single file</h4>

<p>In some cases, it is convenient to have all of the MD5 hashes in the same file. For example, when registering samples in the European Nucleotide Archive, you might have to include the MD5 hashes in its own columns along with other meta-data regarding each sample.</p>

<p>To do so, I submit the <code>md5sum_library.sh</code> to the cluster with the only argument as the absolute path leading to the FASTQ library.</p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line">sbatch md5sum_library.sh data/davidlab/users/fsm/seq_data/2014.07.07.seq/split.library.output.no.joining/split_by_sample/
</div></code></pre>

<p><strong>md5sum_library.sh</strong></p>



<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><div class="hljs-line"><span class="hljs-meta">#!/bin/sh</span>
</div><div class="hljs-line"><span class="hljs-meta"></span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --time-min=120</span>
</div><div class="hljs-line"><span class="hljs-comment">#SBATCH --mem=2GB</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">md5sum <span class="hljs-variable">$1</span>/forward/ENA_formatted_gz/*fastq.gz &gt; <span class="hljs-variable">$1</span>/forward/ENA_formatted_gz/forward.md5sum
</div><div class="hljs-line">md5sum <span class="hljs-variable">$1</span>/reverse/ENA_formatted_gz/*fastq.gz &gt; <span class="hljs-variable">$1</span>/reverse/ENA_formatted_gz/reverse.md5sum
</div></code></pre>

<p>The output are two files (one for forward reads and one for reverse reads) that look like this. I shortened the full path name only for easier visualization.</p>

<table><tbody><tr style="font-weight:bold">  <td align="left">MD5 hash</td>  <td align="left">file</td></tr><tr>  <td align="left">ac4040592106e5359f5d0c07af7a599f</td>  <td align="left">/home/lad44/…/forward/ENA_formatted_gz/SMIC.001.01.Day.02.fastq.gz</td></tr><tr>  <td align="left">9f9aa5018335741dcd159f423ec48cf7</td>  <td align="left">/home/lad44/…/forward/ENA_formatted_gz/SMIC.001.02.Day.02.fastq.gz</td></tr><tr>  <td align="left">d8a64e2920bb461f7113c9c69b184375</td>  <td align="left">/home/lad44/…/forward/ENA_formatted_gz/SMIC.001.02.Day.10.fastq.gz</td></tr></tbody></table>

<p>Time estimate: This is very fast. It might only take a minute for a MiSeq run sequencing data.</p>

<hr>

<p>The protocols should discuss briefly the metadata needed by ENA for all samples. There are two types of metadata: (1) metadata about the biological samples, and (2) metadata about the processing/sequencing of the samples. Below is an example of the metadata I include with the sequences from the cholera project uploaded to ENA.</p>

<p><strong>(1) Metadata about the biological samples (cholera project example)</strong></p>

<table><tbody><tr style="font-weight:bold">  <td align="left">key</td>  <td align="left">value</td>  <td align="left">example</td></tr><tr>  <td align="left">sample_alias</td>  <td align="left"></td>  <td align="left">SMIC.001.01.Day.02</td></tr><tr>  <td align="left">sample_title</td>  <td align="left"></td>  <td align="left">1</td></tr><tr>  <td align="left">investigation type</td>  <td align="left"></td>  <td align="left">mimarks-survey</td></tr><tr>  <td align="left">project name</td>  <td align="left"></td>  <td align="left">cholera susceptibility</td></tr><tr>  <td align="left">sequencing method</td>  <td align="left"></td>  <td align="left">Illumina</td></tr><tr>  <td align="left">collection date</td>  <td align="left"></td>  <td align="left">2013</td></tr><tr>  <td align="left">geographic location (country and/or sea)</td>  <td align="left"></td>  <td align="left">Bangladesh</td></tr><tr>  <td align="left">geographic location (latitude)</td>  <td align="left"></td>  <td align="left">23.7</td></tr><tr>  <td align="left">geographic location (longitude)</td>  <td align="left"></td>  <td align="left">90.3667</td></tr><tr>  <td align="left">human gut environmental package</td>  <td align="left"></td>  <td align="left">human-gut</td></tr><tr>  <td align="left">environment (biome)</td>  <td align="left"></td>  <td align="left">ENVO:urban biome</td></tr><tr>  <td align="left">environment (feature)</td>  <td align="left"></td>  <td align="left">ENVO:human-associated habitat</td></tr><tr>  <td align="left">environment (material)</td>  <td align="left"></td>  <td align="left">ENVO:feces</td></tr></tbody></table>

<p><strong>(2) Metadata about prcessing/sequencing of biological samples (cholera project example)</strong></p>

<table><tbody><tr style="font-weight:bold">  <td align="left">key</td>  <td align="left">value</td>  <td align="left">example</td></tr><tr>  <td align="left">project_accession</td>  <td align="left">this is generated by ENA</td>  <td align="left">PRJEB17860</td></tr><tr>  <td align="left">sample_alias</td>  <td align="left"></td>  <td align="left">SMIC.001.01.Day.02</td></tr><tr>  <td align="left">run_alias</td>  <td align="left">this is generated by ENA</td>  <td align="left">ena-RUN-DUKE UNIV-27-11-2016-23:51:21:383-1</td></tr><tr>  <td align="left">library_name</td>  <td align="left"></td>  <td align="left">unspecified</td></tr><tr>  <td align="left">library_source</td>  <td align="left"></td>  <td align="left">METAGENOMIC</td></tr><tr>  <td align="left">library_selection</td>  <td align="left"></td>  <td align="left">PCR</td></tr><tr>  <td align="left">library_strategy</td>  <td align="left"></td>  <td align="left">AMPLICON</td></tr><tr>  <td align="left">instrument_model</td>  <td align="left"></td>  <td align="left">Illumina MiSeq</td></tr><tr>  <td align="left">file_type</td>  <td align="left"></td>  <td align="left">fastq</td></tr><tr>  <td align="left">library_layout</td>  <td align="left"></td>  <td align="left">PAIRED</td></tr><tr>  <td align="left">insert_size</td>  <td align="left"></td>  <td align="left">151</td></tr><tr>  <td align="left">forward_file_name</td>  <td align="left"></td>  <td align="left">SMIC.001.01.Day.02_1.fastq</td></tr><tr>  <td align="left">reverse_file_md5</td>  <td align="left"></td>  <td align="left">714fc74ed2f5a2b0bf3fa7944541bfd6</td></tr><tr>  <td align="left">reverse_file_name</td>  <td align="left"></td>  <td align="left">SMIC.001.01.Day.02_2.fastq</td></tr><tr>  <td align="left">reverse_file_md5</td>  <td align="left"></td>  <td align="left">4272a174c217dd193d2f26b18080200c</td></tr></tbody></table></div></body></html>
